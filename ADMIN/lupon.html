<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lupon | SANTA FE</title>
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="public/styles/styles.css">
    <style>
        /* Adjust the size and scrollable area for textarea */
        .floating-label textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .modal-content {
            max-width: 600px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <center>
            <img src="https://www.dropbox.com/scl/fi/hplpyx3p3gjc3ozhxa7w6/Dasmarinas-removebg-preview.png?rlkey=bw11d1gi5odcv59ingug5pjeh&st=tl9dj1dk&dl=1" class="Logo">
            <h1>BARANGAY SANTA FE<br>CITY OF DASMARIÃ‘AS</h1>
        </center>
        <div class="sidenav">
            <ul>
                <li><a href="dashboard.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/es7o8fr6dw2vkkywjpg66/dashboard.png?rlkey=pp0dy252j9wao81jpz1n50f4p&st=83lbnbnz&dl=1" class="sidebar-icon">Dashboard</a></li>
                <li><a href="notification.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/te9qkrjtunarm8znvfs1w/notification.png?rlkey=kqzy50yimgtro1l8caiqnqbua&st=4zuvr1p0&dl=1" class="sidebar-icon">Notification</a></li>
                <li><a href="user-account.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/tnounxbo8vd5763gnoysp/userAccount.png?rlkey=hyos7zrh4ghwr66mjivsqfd5b&st=4ko3y2wy&dl=1" class="sidebar-icon">User Account</a></li>
                <li><a href="residents.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/e57yqafcdt0z58wbgvv9e/residents.png?rlkey=wcqigcrhwveax3qubldx0qaql&st=np6th3hf&dl=1" class="sidebar-icon">Residents</a></li>
                <li><a href="complaints.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/kbs0xnrc9usw40lv30clw/scales-of-justice.png?rlkey=d36ewu4dge121egpw53qri8mf&st=r04p7f12&dl=1" class="sidebar-icon">Complaints</a></li>
                <li><a href="barangay-id.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/5bv5aqyto4z9york6lzwq/id-card.png?rlkey=crbfg36zcmb1tq9yfdg0t8zm2&st=ocm8u8fd&dl=1" class="sidebar-icon">Barangay ID</a></li>
                <li><a href="request.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/idqomcr0ujnsmd54ktpu5/quote-request.png?rlkey=swquji94hs61jlr8y0p992s0n&st=vkr8y4i7&dl=1" class="sidebar-icon">Requests</a></li>
            </ul>
        </div>
    </div>
    <div class="main-content">
        <div class="header">
            <h2>Lupon</h2>
            <div class="user-info">
                <div class="dropdown">
                    <img src="https://www.dropbox.com/scl/fi/oedqyjb59kspzdylesk6y/user.png?rlkey=1axl685fxswp7olj90dbgu53y&st=7jh50r8n&dl=1" alt="User Avatar" class="dropbtn" onclick="toggleDropdown()">
                    <div id="myDropdown" class="dropdown-content">
                        <a href="admin-details.html" onclick="viewProfile()">User Profile</a>
                        <a href="module.html">Maintenance</a>
                        <a href="#" onclick="logout()">Logout</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="search-and-actions">
            <div class="search-box">
                <input type="text" placeholder="Search..." oninput="searchLuponAndKasunduan()">
            </div>
            <div class="filter-box">
                <select onchange="navigateToPage(this)">
                    <option value="lupon.html" selected>Processing</option>
                    <option value="lupon-complete.html">Completed</option>
                </select>
            </div>
            <div class="account-actions">
                <!-- Add Modal Triggers -->
                <button class="add-btn" onclick="openAddKasunduanModal()">Add Kasunduan</button>
            </div>
        </div>

        <!-- Lupon Table -->
<div class="account-content">
    <h3>Lupon</h3>
    <div class="table-scroll"> <!-- Scrollable area -->
        <table>
            <thead>
                <tr>
                    <th>Petsa</th>
                    <th>Usapin Blg.</th>
                    <th>Nagsumbong</th>
                    <th>Laban kay</th>
                    <th>Sumbong</th>
                    <th>Lunas</th>
                    <th>Hearing Stage</th>
                    <th>Hearing Date</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="lupon-table-body">
                <!-- Rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Kasunduan Table -->
<div class="account-content">
    <h3>Kasunduan</h3>
    <div class="table-scroll"> <!-- Scrollable area -->
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Complainant's Name</th>
                    <th>Complainee's Name</th>
                    <th>Kasunduan</th>
                    <th>Lupong Tagapamahala</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="kasunduan-table-body">
                <!-- Rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>
</div>

        <!-- Add Kasunduan Modal -->
        <div id="addKasunduanModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddKasunduanModal()">&times;</span>
                <h2>ADD KASUNDUAN</h2>
                <form id="addKasunduanForm">
                    <div class="form-row">
                        <div class="floating-label">
                            <input type="date" id="kasunduanDate" placeholder=" " required>
                            <label for="kasunduanDate">Date</label>
                        </div>
                        <div class="floating-label">
                            <input type="time" id="kasunduanTime" placeholder=" " required>
                            <label for="kasunduanTime">Time</label>
                        </div>
                    </div>
                    <!-- Complainant's Name Fields -->
            <div class="form-row">
                <div>
                    <button type="button" class="add-btn-name" onclick="addLuponKasunduanComplainant()">+</button>
                </div>
                <div class="floating-label">
                    <input type="text" id="kasunduanComplainantFirstName" placeholder=" " required>
                    <label for="kasunduanComplainantFirstName">Complainant's First Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="kasunduanComplainantMiddleName" placeholder=" " required>
                    <label for="kasunduanComplainantMiddleName">Complainant's Middle Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="kasunduanComplainantLastName" placeholder=" " required>
                    <label for="kasunduanComplainantLastName">Complainant's Last Name</label>
                </div>
            </div>

            <!-- Complainee's Name Fields -->
            <div class="form-row">
                <div>
                    <button type="button" class="add-btn-name" onclick="addLuponKasunduanComplainant()">+</button>
                </div>
                <div class="floating-label">
                    <input type="text" id="kasunduanComplaineeFirstName" placeholder=" " required>
                    <label for="kasunduanComplaineeFirstName">Complainee's First Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="kasunduanComplaineeMiddleName" placeholder=" " required>
                    <label for="kasunduanComplaineeMiddleName">Complainee's Middle Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="kasunduanComplaineeLastName" placeholder=" " required>
                    <label for="kasunduanComplaineeLastName">Complainee's Last Name</label>
                </div>
            </div>

                    <div class="form-row">
                        <div class="floating-label">
                            <textarea id="kasunduanText" placeholder=" " required></textarea>
                            <label for="kasunduanText">Kasunduan</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="floating-label">
                            <select id="kasunduanJusticeOnDuty" required>
                                <option value="" disabled selected>Select Lupong Tagapamahala</option>
                            </select>
                            <label for="kasunduanJusticeOnDuty">Lupong Tagapamahala</label>
                        </div>
                        <div class="floating-label">
                            <select id="kasunduanStatus" required>
                                <option value="Processing">Processing</option>
                            </select>
                            <label for="kasunduanStatus">Status</label>
                        </div>
                    </div>
                    <div class="button-container">
                        <button type="submit" class="add-btn">Add Kasunduan</button>
                        <button type="button" class="cancel-btn" onclick="closeAddKasunduanModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Lupon Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>EDIT LUPON</h2>
        <form id="editLuponForm">
            <input type="hidden" id="editId">
            <div class="form-row">
                <div class="floating-label">
                    <input type="date" id="editDate" placeholder=" " readonly>
                    <label for="editDate">Petsa</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editText" placeholder=" " required>
                    <label for="editText">Usapin Blg.</label>
                </div>
            </div>
           <!-- Nagsumbong Fields for Edit -->
           <div class="form-row">
            <div class="floating-label">
                <input type="text" id="editComplainantFirstName" placeholder=" " required>
                <label for="editComplainantFirstName">Nagsumbong First Name</label>
            </div>
            <div class="floating-label">
                <input type="text" id="editComplainantMiddleName" placeholder=" " required>
                <label for="editComplainantMiddleName">Nagsumbong Middle Name</label>
            </div>
            <div class="floating-label">
                <input type="text" id="editComplainantLastName" placeholder=" " required>
                <label for="editComplainantLastName">Nagsumbong Last Name</label>
            </div>
        </div>

        <!-- Laban Kay Fields for Edit -->
        <div class="form-row">
            <div class="floating-label">
                <input type="text" id="editComplaineeFirstName" placeholder=" " required>
                <label for="editComplaineeFirstName">Laban Kay First Name</label>
            </div>
            <div class="floating-label">
                <input type="text" id="editComplaineeMiddleName" placeholder=" " required>
                <label for="editComplaineeMiddleName">Laban Kay Middle Name</label>
            </div>
            <div class="floating-label">
                <input type="text" id="editComplaineeLastName" placeholder=" " required>
                <label for="editComplaineeLastName">Laban Kay Last Name</label>
            </div>
        </div>
            <div class="form-row">
                <div class="floating-label">
                    <textarea id="editSumbong" placeholder=" " required></textarea>
                    <label for="editSumbong">Sumbong</label>
                </div>
            </div>
            <div class="form-row">
                <div class="floating-label">
                    <textarea id="editLunas" placeholder=" " required></textarea>
                    <label for="editLunas">Lunas</label>
                </div>
            </div>
            <div class="form-row">
                <div class="floating-label">
                    <select id="editHearingStage" required>
                      <option value="1" disabled>1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                    <label for="editHearingStage">Hearing Stage</label>
                </div>
                <div class="floating-label">
                    <input type="date" id="editHearingDate" placeholder=" " required>
                    <label for="editHearingDate">Hearing Date</label>
                </div>
                <div class="floating-label">
                    <select id="editStatus" required>
                        <option value="Processing">Processing</option>
                        <option value="Transfer to CFA">Transfer to CFA</option>
                        <option value="Completed">Completed</option>
                    </select>
                    <label for="editStatus">Status</label>
                </div>
            </div>
            <div class="button-container">
                <button type="submit" class="edit-btn">Edit Lupon</button>
                <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

        <!-- Edit Kasunduan Modal -->
<div id="editKasunduanModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditKasunduanModal()">&times;</span>
        <h2>EDIT KASUNDUAN</h2>
        <form id="editKasunduanForm">
            <input type="hidden" id="editKasunduanId">
            <div class="form-row">
                <div class="floating-label">
                    <input type="date" id="editKasunduanDate" placeholder=" " required>
                    <label for="editKasunduanDate">Date</label>
                </div>
                <div class="floating-label">
                    <input type="time" id="editKasunduanTime" placeholder=" " required>
                    <label for="editKasunduanTime">Time</label>
                </div>
            </div>
            <!-- Complainant's Name Fields for Edit -->
            <div class="form-row">
                <div class="floating-label">
                    <input type="text" id="editKasunduanComplainantFirstName" placeholder=" " required>
                    <label for="editKasunduanComplainantFirstName">Complainant's First Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editKasunduanComplainantMiddleName" placeholder=" " required>
                    <label for="editKasunduanComplainantMiddleName">Complainant's Middle Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editKasunduanComplainantLastName" placeholder=" " required>
                    <label for="editKasunduanComplainantLastName">Complainant's Last Name</label>
                </div>
            </div>

            <!-- Complainee's Name Fields for Edit -->
            <div class="form-row">
                <div class="floating-label">
                    <input type="text" id="editKasunduanComplaineeFirstName" placeholder=" " required>
                    <label for="editKasunduanComplaineeFirstName">Complainee's First Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editKasunduanComplaineeMiddleName" placeholder=" " required>
                    <label for="editKasunduanComplaineeMiddleName">Complainee's Middle Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editKasunduanComplaineeLastName" placeholder=" " required>
                    <label for="editKasunduanComplaineeLastName">Complainee's Last Name</label>
                </div>
            </div>
            <div class="form-row">
                <div class="floating-label">
                    <textarea id="editKasunduanText" placeholder=" " required></textarea>
                    <label for="editKasunduanText">Kasunduan</label>
                </div>
            </div>
            <div class="form-row">
                <div class="floating-label">
                    <select id="editKasunduanJusticeOnDuty" required>
                        <option value="" disabled selected>Select Lupong Tagapamahala</option>
                    </select>
                    <label for="editKasunduanJusticeOnDuty">Lupong Tagapamahala</label>
                </div>
                <div class="floating-label">
                    <select id="editKasunduanStatus" required>
                        <option value="Processing">Processing</option>
                        <option value="Completed">Completed</option>
                    </select>
                    <label for="editKasunduanStatus">Status</label>
                </div>
            </div>
            <div class="button-container">
                <button type="submit" class="edit-btn">Edit Kasunduan</button>
                <button type="button" class="cancel-btn" onclick="closeEditKasunduanModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="public/styles/script.js"></script>
    <script src="/public/js/sessionTimeout.js"></script>
    <script>
        //SEARCH
        function searchLuponAndKasunduan() {
    // Get the search input value
    const searchValue = document.querySelector('.search-box input').value.toLowerCase();

    // Search Lupon Table
    const luponRows = document.querySelectorAll('#lupon-table-body tr');
    luponRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const matches = Array.from(cells).some(cell => 
            cell.textContent.toLowerCase().includes(searchValue)
        );
        if (matches) {
            row.style.display = ''; // Show the row
        } else {
            row.style.display = 'none'; // Hide the row
        }
    });

    // Search Kasunduan Table
    const kasunduanRows = document.querySelectorAll('#kasunduan-table-body tr');
    kasunduanRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const matches = Array.from(cells).some(cell => 
            cell.textContent.toLowerCase().includes(searchValue)
        );
        if (matches) {
            row.style.display = ''; // Show the row
        } else {
            row.style.display = 'none'; // Hide the row
        }
    });
}

        // DISPLAY TABLE

        // Fetch Lupon Data
async function fetchLuponData() {
  try {
    const response = await fetch('/fetch-lupon');
    const luponData = await response.json();

    const luponTableBody = document.getElementById('lupon-table-body');
    luponTableBody.innerHTML = ''; // Clear existing rows

    luponData.forEach(lupon => {
      const row = document.createElement('tr');
      row.innerHTML = `
    <td>${lupon.petsa}</td>
    <td>${lupon.usapinBlg}</td>
    <td>${lupon.complainantFirstName} ${lupon.complainantMiddleName} ${lupon.complainantLastName}</td>
    <td>${lupon.complaineeFirstName} ${lupon.complaineeMiddleName} ${lupon.complaineeLastName}</td>
    <td>${lupon.sumbong}</td>
    <td>${lupon.lunas}</td>
    <td>${lupon.hearingStage}</td>
    <td>${lupon.hearingDate}</td>
    <td>${lupon.status}</td>
         <td>
          <a href="#"><img src="https://www.dropbox.com/scl/fi/u6i83geituweeaybi8y9w/pen.png?rlkey=5f7vjmsrn42d1t0iaxdu3jbjy&st=0sk8r60h&dl=1" alt="Edit" class="edit-icon" onclick="openEditModal('${lupon._id}', '${lupon.petsa}', '${lupon.usapinBlg}', '${lupon.complainantFirstName}', '${lupon.complainantMiddleName}', '${lupon.complainantLastName}', '${lupon.complaineeFirstName}', '${lupon.complaineeMiddleName}', '${lupon.complaineeLastName}', '${lupon.sumbong}', '${lupon.lunas}', '${lupon.hearingStage}', '${lupon.hearingDate}', '${lupon.status}')"></a>
          <a href="#"><img src="https://www.dropbox.com/scl/fi/ho6y40rqr930v22ja9219/delete.png?rlkey=b1xjg0s1v3rnrgjx1n5v2usgm&st=xgbxk20f&dl=1" alt="Delete" class="delete-icon" onclick="deleteLupon('${lupon._id}')"></a>
          ${lupon.hearingStage === "3" ? `<a href="#"><img src="https://www.dropbox.com/scl/fi/v185qat4whwt769dbbbya/blueDocument.png?rlkey=uy1zoguvwgxd55x7sw6ki8c6h&st=4jg7gfil&dl=1" alt="Generate" class="generate-icon" onclick="generateLupon('${lupon._id}')"></a>` : ''}
          ${lupon.status === 'Completed' ? `<a href="#"><img src="https://www.dropbox.com/scl/fi/brbnzjxfdeqjerssseaxc/checked.png?rlkey=yinbka4wjvra6n5dxazi4l13a&st=wpwljnp2&dl=1" alt="Transfer" class="transfer-icon" onclick="transferLupon('${lupon._id}')"></a>` : ''}
          ${lupon.status === 'Transfer to CFA' ? `<a href="#"><img src="https://www.dropbox.com/scl/fi/brbnzjxfdeqjerssseaxc/checked.png?rlkey=yinbka4wjvra6n5dxazi4l13a&st=wpwljnp2&dl=1" alt="Transfer" class="transfer-icon" onclick="transfertoCFA('${lupon._id}')"></a>` : ''}
          </td>
      `;
      luponTableBody.appendChild(row);
    });
  } catch (err) {
    console.error('Error fetching lupon data:', err);
  }
}

// Fetch Kasunduan Data
async function fetchKasunduanData() {
  try {
    const response = await fetch('/fetch-lupon-kasunduan');
    const kasunduanData = await response.json();

    const kasunduanTableBody = document.getElementById('kasunduan-table-body');
    kasunduanTableBody.innerHTML = ''; // Clear existing rows

    kasunduanData.forEach(kasunduan => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${kasunduan.date}</td>
        <td>${kasunduan.time}</td>
        <td>${kasunduan.complainantFirstName} ${kasunduan.complainantMiddleName} ${kasunduan.complainantLastName}</td>
        <td>${kasunduan.complaineeFirstName} ${kasunduan.complaineeMiddleName} ${kasunduan.complaineeLastName}</td>
        <td>${kasunduan.kasunduan}</td>
        <td>${kasunduan.justiceOnDuty}</td>
        <td>${kasunduan.status}
        <td>
          <a href="#"><img src="https://www.dropbox.com/scl/fi/u6i83geituweeaybi8y9w/pen.png?rlkey=5f7vjmsrn42d1t0iaxdu3jbjy&st=0sk8r60h&dl=1" alt="Edit" class="edit-icon"onclick="openEditKasunduanModal('${kasunduan._id}', '${kasunduan.date}', '${kasunduan.time}', '${kasunduan.complainantFirstName}', '${kasunduan.complainantMiddleName}', '${kasunduan.complainantLastName}', '${kasunduan.complaineeFirstName}', '${kasunduan.complaineeMiddleName}', '${kasunduan.complaineeLastName}', '${kasunduan.kasunduan}', '${kasunduan.justiceOnDuty}', '${kasunduan.status}')"></a>
          <a href="#"><img src="https://www.dropbox.com/scl/fi/ho6y40rqr930v22ja9219/delete.png?rlkey=b1xjg0s1v3rnrgjx1n5v2usgm&st=xgbxk20f&dl=1" alt="Delete" class="delete-icon" onclick="deleteKasunduan('${kasunduan._id}')"></a>
          <a href="#"><img src="https://www.dropbox.com/scl/fi/v185qat4whwt769dbbbya/blueDocument.png?rlkey=uy1zoguvwgxd55x7sw6ki8c6h&st=4jg7gfil&dl=1" alt="Generate" class="generate-icon" onclick="generateLuponKasunduan('${kasunduan._id}')"></a>

          ${kasunduan.status === 'Completed' ? `<a href="#"><img src="https://www.dropbox.com/scl/fi/brbnzjxfdeqjerssseaxc/checked.png?rlkey=yinbka4wjvra6n5dxazi4l13a&st=wpwljnp2&dl=1" alt="Transfer" class="transfer-icon" onclick="transferkasunduan('${kasunduan._id}')"></a>` : ''}
        </td>
      `;
      kasunduanTableBody.appendChild(row);
    });
  } catch (err) {
    console.error('Error fetching kasunduan data:', err);
  }
}

// Call the functions to fetch and populate the data when the page loads
document.addEventListener('DOMContentLoaded', () => {
  fetchLuponData();
  fetchKasunduanData();
});

// ADDING KASUNDUAN
// Function to open Add Kasunduan Modal and populate Lupong Tagapamahala dropdown
function openAddKasunduanModal() {
    const addKasunduanModal = document.getElementById('addKasunduanModal');
    addKasunduanModal.style.display = 'block'; // Display the modal

    // Clear previous options (in case the modal is reopened)
    const dropdown = document.getElementById('kasunduanJusticeOnDuty');
    dropdown.innerHTML = '<option value="" disabled selected>Select Lupong Tagapamahala</option>';

    // Fetch Lupon Tagapamahala members from your server.js endpoint and populate the dropdown
    fetch('/fetch-pangkat-members')  // This endpoint will fetch the members from the server
        .then(response => response.json())
        .then(data => {
            data.forEach(member => {
                const option = document.createElement('option');
                option.value = `${member.firstName} ${member.middleName} ${member.lastName}`;
                option.textContent = `${member.firstName} ${member.middleName} ${member.lastName}`;
                dropdown.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching Lupon Tagapamahala members:', error));
}

document.getElementById('addKasunduanForm').addEventListener('submit', async function(event) {
    event.preventDefault();

    const newKasunduan = {
        date: document.getElementById('kasunduanDate').value,
        time: document.getElementById('kasunduanTime').value,
        complainantFirstName: document.getElementById('kasunduanComplainantFirstName').value,
        complainantMiddleName: document.getElementById('kasunduanComplainantMiddleName').value,
        complainantLastName: document.getElementById('kasunduanComplainantLastName').value,
        complaineeFirstName: document.getElementById('kasunduanComplaineeFirstName').value,
        complaineeMiddleName: document.getElementById('kasunduanComplaineeMiddleName').value,
        complaineeLastName: document.getElementById('kasunduanComplaineeLastName').value,
        kasunduan: document.getElementById('kasunduanText').value,
        justiceOnDuty: document.getElementById('kasunduanJusticeOnDuty').value,
        status: document.getElementById('kasunduanStatus').value,
    };

    try {
        const response = await fetch('/add-lupon-kasunduan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newKasunduan)
        });

        const result = await response.json();
        if (result.success) {
            closeAddKasunduanModal(); // Close modal after submission
            fetchKasunduanData(); // Refresh the table to show the new entry
        } else {
            alert('Failed to add Kasunduan');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

function closeAddKasunduanModal() {
  const addKasunduanModal = document.getElementById('addKasunduanModal');
  addKasunduanModal.style.display = 'none'; // Hide the modal
}

function setMinHearingDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('editHearingDate').setAttribute('min', today); // Restrict dates to today onwards
}

// Open Edit Lupon Modal and Populate Fields
function openEditModal(id, date, usapinBlg, complainantFirstName, complainantMiddleName, complainantLastName, complaineeFirstName, complaineeMiddleName, complaineeLastName, sumbong, lunas, hearingStage, hearingDate, status) {
    document.getElementById('editId').value = id;
    document.getElementById('editDate').value = date;
    document.getElementById('editText').value = usapinBlg;
    document.getElementById('editComplainantFirstName').value = complainantFirstName;
    document.getElementById('editComplainantMiddleName').value = complainantMiddleName;
    document.getElementById('editComplainantLastName').value = complainantLastName;
    document.getElementById('editComplaineeFirstName').value = complaineeFirstName;
    document.getElementById('editComplaineeMiddleName').value = complaineeMiddleName;
    document.getElementById('editComplaineeLastName').value = complaineeLastName;
    document.getElementById('editSumbong').value = sumbong;
    document.getElementById('editLunas').value = lunas;
    document.getElementById('editHearingStage').value = hearingStage;
    document.getElementById('editHearingDate').value = hearingDate;
    document.getElementById('editStatus').value = status;

    setMinHearingDate(); // Set minimum date for the hearing date
    // Display the Edit Modal
    document.getElementById('editModal').style.display = 'block';
}

// Edit Lupon Form Submission
document.getElementById('editLuponForm').addEventListener('submit', async function(event) {
    event.preventDefault();

    const updatedLupon = {
        petsa: document.getElementById('editDate').value,
        usapinBlg: document.getElementById('editText').value,
        complainantFirstName: document.getElementById('editComplainantFirstName').value,
        complainantMiddleName: document.getElementById('editComplainantMiddleName').value,
        complainantLastName: document.getElementById('editComplainantLastName').value,
        complaineeFirstName: document.getElementById('editComplaineeFirstName').value,
        complaineeMiddleName: document.getElementById('editComplaineeMiddleName').value,
        complaineeLastName: document.getElementById('editComplaineeLastName').value,
        sumbong: document.getElementById('editSumbong').value,
        lunas: document.getElementById('editLunas').value,
        hearingStage: document.getElementById('editHearingStage').value,
        hearingDate: document.getElementById('editHearingDate').value,
        status: document.getElementById('editStatus').value,
    };

    const luponId = document.getElementById('editId').value;

    try {
        const response = await fetch(`/update-lupon/${luponId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedLupon)
        });

        const result = await response.json();
        if (result.success) {
            closeEditModal(); // Close the Edit Modal
            fetchLuponData(); // Refresh the table to reflect the updates
        } else {
            alert('Failed to update Lupon');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

function closeEditModal() {
    const editModal = document.getElementById('editModal');
    editModal.style.display = 'none'; // Hide the modal
}


// EDITING KASUNDUAN
// Function to open Edit Kasunduan Modal and populate fields
function openEditKasunduanModal(id, date, time, complainantFirstName, complainantMiddleName, complainantLastName, complaineeFirstName, complaineeMiddleName, complaineeLastName, kasunduan, justiceOnDuty, status) {
    // Open the modal
    const editKasunduanModal = document.getElementById('editKasunduanModal');
    editKasunduanModal.style.display = 'block';

    // Populate the modal form fields with the data
    document.getElementById('editKasunduanId').value = id;
    document.getElementById('editKasunduanDate').value = date;
    document.getElementById('editKasunduanTime').value = time;
    document.getElementById('editKasunduanComplainantFirstName').value = complainantFirstName;
    document.getElementById('editKasunduanComplainantMiddleName').value = complainantMiddleName;
    document.getElementById('editKasunduanComplainantLastName').value = complainantLastName;
    document.getElementById('editKasunduanComplaineeFirstName').value = complaineeFirstName;
    document.getElementById('editKasunduanComplaineeMiddleName').value = complaineeMiddleName;
    document.getElementById('editKasunduanComplaineeLastName').value = complaineeLastName;
    document.getElementById('editKasunduanText').value = kasunduan;

    // Fetch and populate the Lupong Tagapamahala dropdown
    const dropdown = document.getElementById('editKasunduanJusticeOnDuty');
    dropdown.innerHTML = '<option value="" disabled>Select Lupong Tagapamahala</option>'; // Reset dropdown

    // Fetch Lupon Tagapamahala members from the server and populate the dropdown
    fetch('/fetch-pangkat-members')
        .then(response => response.json())
        .then(data => {
            data.forEach(member => {
                const option = document.createElement('option');
                option.value = `${member.firstName} ${member.middleName} ${member.lastName}`;
                option.textContent = `${member.firstName} ${member.middleName} ${member.lastName}`;
                dropdown.appendChild(option);
            });

            // Preselect the current justiceOnDuty value in the dropdown
            dropdown.value = justiceOnDuty;
        })
        .catch(error => console.error('Error fetching Lupon Tagapamahala members:', error));

    // Set the status
    document.getElementById('editKasunduanStatus').value = status;
}



document.getElementById('editKasunduanForm').addEventListener('submit', async function(event) {
    event.preventDefault();

    const updatedKasunduan = {
        date: document.getElementById('editKasunduanDate').value,
        time: document.getElementById('editKasunduanTime').value,
        complainantFirstName: document.getElementById('editKasunduanComplainantFirstName').value,
        complainantMiddleName: document.getElementById('editKasunduanComplainantMiddleName').value,
        complainantLastName: document.getElementById('editKasunduanComplainantLastName').value,
        complaineeFirstName: document.getElementById('editKasunduanComplaineeFirstName').value,
        complaineeMiddleName: document.getElementById('editKasunduanComplaineeMiddleName').value,
        complaineeLastName: document.getElementById('editKasunduanComplaineeLastName').value,
        kasunduan: document.getElementById('editKasunduanText').value,
        justiceOnDuty: document.getElementById('editKasunduanJusticeOnDuty').value,
        status: document.getElementById('editKasunduanStatus').value,
    };

    const kasunduanId = document.getElementById('editKasunduanId').value;

    try {
        const response = await fetch(`/update-lupon-kasunduan/${kasunduanId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedKasunduan)
        });

        const result = await response.json();
        if (result.success) {
            closeEditKasunduanModal(); // Close modal after submission
            fetchKasunduanData(); // Refresh the table to show the updated entry
        } else {
            alert('Failed to update Kasunduan');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

function closeEditKasunduanModal() {
    const editKasunduanModal = document.getElementById('editKasunduanModal');
    editKasunduanModal.style.display = 'none'; // Hide the modal
}

// TO MAKE THE FORM CLOSE THROUGH CLICKING OUTSIDE
window.onclick = function(event) {
  const addLuponModal = document.getElementById('addModal');
  const addKasunduanModal = document.getElementById('addKasunduanModal');

  if (event.target == addLuponModal) {
    addLuponModal.style.display = 'none';
  }
  
  if (event.target == addKasunduanModal) {
    addKasunduanModal.style.display = 'none';
  }
}

// DELETING LUPON AND KASUNDUAN DATA
async function deleteLupon(id) {
    if (confirm('Are you sure you want to delete this entry?')) {
        try {
            const response = await fetch(`/delete-lupon/${id}`, {
                method: 'DELETE',
            });

            const result = await response.json();
            if (result.success) {
                fetchLuponData(); // Refresh the Lupon table
            } else {
                alert('Failed to delete Lupon entry');
            }
        } catch (error) {
            console.error('Error deleting Lupon entry:', error);
        }
    }
}

async function deleteKasunduan(id) {
    if (confirm('Are you sure you want to delete this entry?')) {
        try {
            const response = await fetch(`/delete-lupon-kasunduan/${id}`, {
                method: 'DELETE',
            });

            const result = await response.json();
            if (result.success) {
                fetchKasunduanData(); // Refresh the Kasunduan table
            } else {
                alert('Failed to delete Kasunduan entry');
            }
        } catch (error) {
            console.error('Error deleting Kasunduan entry:', error);
        }
    }
}

// TRANSFER LUPON
async function transferLupon(id) {
    if (confirm('Are you sure you want to transfer this entry?')) {
        try {
            const response = await fetch(`/transfer-lupon/${id}`, {
                method: 'PUT',
            });

            const result = await response.json();
            if (result.success) {
                fetchLuponData(); // Refresh the Lupon table
            } else {
                alert('Failed to transfer Lupon entry');
            }
        } catch (error) {
            console.error('Error transferring Lupon entry:', error);
        }
    }
}

async function transfertoCFA(id) {
    try {
        const response = await fetch(`/transfer-to-cfa/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert("Successfully transferred to CFA!");
            // Optionally, reload or update the table to reflect the new status
            fetchLuponData(); // Call this function if you have it to refresh the data
        } else {
            alert("Transfer failed: " + data.message);
        }
    } catch (error) {
        console.error("Error transferring to CFA:", error);
    }
}


// TRANSFER KASUNDUAN
async function transferkasunduan(id) {
    if (confirm('Are you sure you want to transfer this Kasunduan entry?')) {
        try {
            const response = await fetch(`/transfer-lupon-kasunduan/${id}`, {
                method: 'PUT',
            });

            if (response.ok) {
                const result = await response.json(); // Use JSON only if the response is JSON
                if (result.success) {
                    fetchKasunduanData(); // Refresh the Kasunduan table
                } else {
                    alert('Failed to transfer Kasunduan entry');
                }
            } else {
                const errorText = await response.text(); // Catch plain text errors
                alert(`Error: ${errorText}`);
            }
        } catch (error) {
            console.error('Error transferring Kasunduan entry:', error);
        }
    }
}

function generateLupon(id) {
  fetch(`/fetch-lupon/${id}`)
    .then(response => response.json())
    .then(data => {
      console.log("Fetched Data:", data); // Log to check the API response
      if (data) {
        const params = new URLSearchParams({
          date: data.petsa,
          usapinBlg: data.usapinBlg,
          nagsumbong: `${data.complainantFirstName} ${data.complainantMiddleName} ${data.complainantLastName}`,
          labanKay: `${data.complaineeFirstName} ${data.complaineeMiddleName} ${data.complaineeLastName}`,
          sumbong: data.sumbong,
          lunas: data.lunas,
          hearingStage: data.hearingStage,
          hearingDate: data.hearingDate,
        });

        window.location.href = `generate-lupon.html?${params}`;
      }
    })
    .catch(error => console.error('Error fetching Lupon:', error));
}


function generateLuponKasunduan(id) {
  fetch(`/fetch-lupon-kasunduan/${id}`)
    .then(response => response.json())
    .then(data => {
      if (data) {
        const params = new URLSearchParams({
          date: data.date,
          time: data.time,
          complainantName: `${data.complainantFirstName} ${data.complainantMiddleName} ${data.complainantLastName}`, // Combine full name
          complaineeName: `${data.complaineeFirstName} ${data.complaineeMiddleName} ${data.complaineeLastName}`, // Combine full name
          kasunduan: data.kasunduan,
          justiceOnDuty: data.justiceOnDuty || data.LupongTagapamahala, // In case one is undefined
        });

        // Redirect to the new page with the populated parameters
        window.location.href = `generate-lupon-kasunduan.html?${params}`;
      }
    })
    .catch(error => console.error('Error fetching Kasunduan:', error));
}

    </script>
</body>
</html>
