<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay ID</title>
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="public/admin/brgy-id.css">
</head>
<body>
    <div class="sidebar">
        <center>
            <img src="https://www.dropbox.com/scl/fi/hplpyx3p3gjc3ozhxa7w6/Dasmarinas-removebg-preview.png?rlkey=bw11d1gi5odcv59ingug5pjeh&st=tl9dj1dk&dl=1" class="Logo">
            <h1>BARANGAY SANTA FE<br>CITY OF DASMARIÃ‘AS</h1>
        </center>
        <div class="sidenav">
            <ul>
                <li><a href="dashboard.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/es7o8fr6dw2vkkywjpg66/dashboard.png?rlkey=pp0dy252j9wao81jpz1n50f4p&st=83lbnbnz&dl=1" class="sidebar-icon">Dashboard</a></li>
                <li><a href="notification.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/te9qkrjtunarm8znvfs1w/notification.png?rlkey=kqzy50yimgtro1l8caiqnqbua&st=4zuvr1p0&dl=1" class="sidebar-icon">Notification</a></li>
                <li><a href="user-account.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/tnounxbo8vd5763gnoysp/userAccount.png?rlkey=hyos7zrh4ghwr66mjivsqfd5b&st=4ko3y2wy&dl=1" class="sidebar-icon">User Account</a></li>
                <li><a href="residents.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/e57yqafcdt0z58wbgvv9e/residents.png?rlkey=wcqigcrhwveax3qubldx0qaql&st=np6th3hf&dl=1" class="sidebar-icon">Residents</a></li>
                <li><a href="complaints.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/kbs0xnrc9usw40lv30clw/scales-of-justice.png?rlkey=d36ewu4dge121egpw53qri8mf&st=r04p7f12&dl=1" class="sidebar-icon">Complaints</a></li>
                <li><a href="barangay-id.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/5bv5aqyto4z9york6lzwq/id-card.png?rlkey=crbfg36zcmb1tq9yfdg0t8zm2&st=ocm8u8fd&dl=1" class="sidebar-icon">Barangay ID</a></li>
                <li><a href="request.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/idqomcr0ujnsmd54ktpu5/quote-request.png?rlkey=swquji94hs61jlr8y0p992s0n&st=vkr8y4i7&dl=1" class="sidebar-icon">Requests</a></li>
                <li><a href="module.html" class="sidebar-link"><img src="https://www.dropbox.com/scl/fi/olqdewf6h2pi148jw0j2p/maintenance.png?rlkey=5rnv8iajpbytp799jgyvs6cqa&st=9qpfgd82&dl=1" class="sidebar-icon">Maintenance</a></li>
            </ul>
        </div>
    </div>
    <div class="main-content">
        <div class="header">
            <h2>Barangay ID</h2>
            <div class="user-info">
                <div class="dropdown">
                    <img src="https://www.dropbox.com/scl/fi/oedqyjb59kspzdylesk6y/user.png?rlkey=1axl685fxswp7olj90dbgu53y&st=7jh50r8n&dl=1" alt="User Avatar" class="dropbtn" onclick="toggleDropdown()">
                    <div id="myDropdown" class="dropdown-content">
                        <a href="admin-details.html" onclick="viewProfile()">User Profile</a>
                        <a href="module.html">Maintenance</a>
                        <a href="#" onclick="logout()">Logout</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="search-and-actions">
            <div class="search-box">
                <input type="text" placeholder="Search..." oninput="searchBarangayID()">
            </div>
            <div class="filter-box">
                <select onchange="navigateToPage(this)">
                    <option value="barangay-id.html" selected>Processing</option>
                    <option value="barangay-id-complete.html">Completed</option>
                </select>
            </div>
            <div class="account-actions">
                <button class="add-btn" onclick="openModal()">Add</button>
            </div>
        </div>
        <div class="account-content">
            <h3>Resident Information</h3>
            <div class="account-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>IGP #</th>
                            <th>Name</th>
                            <th>Amount</th>
                            <th>Remarks</th>
                            <th>Received by</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="barangayIdTableBody">
                        <!-- Rows will be appended here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Add Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>ADD BARANGAY ID REQUEST</h2>
        <form id="addForm">
            <div class="form-row">
                <div class="floating-label">
                    <input type="date" id="date" placeholder=" " required>
                    <label for="date">Date</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="igp" name="igp" placeholder=" " required>
                    <label for="igp">IGP #</label>
                </div>
            </div>

            <div class="form-row">
                <div class="floating-label">
                    <input type="text" id="firstName" name="firstName" placeholder=" " required>
                    <label for="firstName">First Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="middleName" name="middleName" placeholder=" ">
                    <label for="middleName">Middle Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="lastName" name="lastName" placeholder=" " required>
                    <label for="lastName">Last Name</label>
                </div>
            </div>
            
            <div class="form-row">
                <div class="floating-label">
                    <input type="text" id="amount" name="amount" placeholder=" " readonly>
                    <label for="amount">Amount</label>
                </div>
            </div>

            <div class="form-row">
                <div class="floating-label">
                    <select id="remarks" name="remarks" onchange="updateAmount()" required>
                        <option value="" disabled selected></option>
                        <option value="Rush">Rush</option>
                        <option value="Regular">Regular</option>
                    </select>
                    <label for="remarks">Remarks</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="receivedBy" name="receivedBy" placeholder=" ">
                    <label for="receivedBy">Received by</label>
                </div>
                <div class="floating-label">
                    <select id="Status" name="Status" required>
                        <option value="" disabled selected></option>
                        <option value="Complete">Complete</option>
                        <option value="Processing">Processing</option>
                    </select>
                    <label for="Status">Status</label>
                </div>
            </div>

            <div class="button-container">
                <button type="button" class="add-btn" onclick="submitAddForm()">Add</button>
                <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
            </div>
        </form>        
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>EDIT BARANGAY ID REQUEST</h2>
        <form id="editForm">
            <div class="form-row">
                <div class="floating-label">
                    <input type="date" id="editDate" placeholder=" " required>
                    <label for="editDate">Edit Date</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editIgp" placeholder=" " name="igp">
                    <label for="editIgp">IGP #</label>
                </div>
            </div>
            <div class="form-row">
                <div class="floating-label">
                    <input type="text" id="editFirstName" placeholder=" " name="firstName" required>
                    <label for="editFirstName">First Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editMiddleName" placeholder=" " name="middleName">
                    <label for="editMiddleName">Middle Name</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editLastName" placeholder=" " name="lastName" required>
                    <label for="editLastName">Last Name</label>
                </div>
            </div>
            <div class="form-row">
                <div class="floating-label">
                    <input type="text" id="editAmount" placeholder=" " name="amount" readonly>
                    <label for="editAmount">Amount</label>
                </div>
            </div>
            <div class="form-row">
                <div class="floating-label">
                    <select id="editRemarks" name="remarks" onchange="updateEditAmount()" required>
                        <option value="" disabled selected>Remarks</option>
                        <option value="Rush">Rush</option>
                        <option value="Regular">Regular</option>
                    </select>
                    <label for="editRemarks">Remarks</label>
                </div>
                <div class="floating-label">
                    <input type="text" id="editReceivedBy" placeholder=" " name="receivedBy">
                    <label for="editReceivedBy">Received by</label>
                </div>
                <div class="floating-label">
                    <select id="editStatus" name="status" placeholder="Status" required>
                        <option value="" disabled selected>Status</option>
                        <option value="Complete">Complete</option>
                        <option value="Processing">Processing</option>
                    </select>
                    <label for="editStatus">Status</label>
                </div>
            </div>
            <div class="button-container">
                <button type="submit" class="add-btn">Edit</button>
                <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

    <script src="public/styles/script.js"></script>
    <script src="/public/js/sessionTimeout.js"></script>
    <script>
        // SEARCH
        function searchBarangayID() {
            const searchValue = document.querySelector('.search-box input').value.toLowerCase();
            const rows = document.querySelectorAll('#barangayIdTableBody tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const matches = Array.from(cells).some(cell => 
                    cell.textContent.toLowerCase().includes(searchValue)
                );

                if (matches) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Add Modal
        function openModal() {
            document.getElementById("addModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("addModal").style.display = "none";
        }

        function submitAddForm() {
            const formData = new FormData(document.getElementById('addForm'));
            const dateValue = new Date(document.getElementById('date').value);
            const formattedDate = dateValue.getFullYear() + '-' +
                                ('0' + (dateValue.getMonth() + 1)).slice(-2) + '-' +
                                ('0' + dateValue.getDate()).slice(-2);

            const newBarangayId = {
                date: formattedDate,
                igp: formData.get('igp'),
                firstName: formData.get('firstName'),
                middleName: formData.get('middleName'),
                lastName: formData.get('lastName'),
                amount: formData.get('amount'),
                remarks: formData.get('remarks'),
                receivedBy: formData.get('receivedBy'),
                status: formData.get('Status') // Include the status field
            };

            fetch('/barangay-ids', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newBarangayId)
            })
            .then(response => {
                if (response.ok) {
                    document.querySelector('form').reset(); // Clear the form
                    closeModal();
                    fetchBarangayIds(); // Refresh the table
                } else {
                    console.error('Error adding barangay ID:', response.statusText);
                }
            })
            .catch(error => console.error('Error adding barangay ID:', error));
        }

        function openEditModal(id) {
            fetch(`/barangay-ids/${id}`)
                .then(response => response.json())
                .then(barangayId => {
                    document.getElementById('editDate').value = barangayId.date || '';
                    document.getElementById('editIgp').value = barangayId.igp || '';
                    document.getElementById('editFirstName').value = barangayId.firstName || '';
                    document.getElementById('editMiddleName').value = barangayId.middleName || '';
                    document.getElementById('editLastName').value = barangayId.lastName || '';
                    document.getElementById('editAmount').value = barangayId.amount || '';
                    document.getElementById('editRemarks').value = barangayId.remarks || '';
                    document.getElementById('editReceivedBy').value = barangayId.receivedBy || '';
                    document.getElementById('editStatus').value = barangayId.status || '';

                    const hiddenIdInput = document.createElement('input');
                    hiddenIdInput.type = 'hidden';
                    hiddenIdInput.id = 'editBarangayId';
                    hiddenIdInput.value = barangayId._id;
                    document.getElementById('editForm').appendChild(hiddenIdInput);

                    document.getElementById('editModal').style.display = 'block';
                })
                .catch(error => console.error('Error fetching barangay ID:', error));
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            const hiddenIdInput = document.getElementById('editBarangayId');
            if (hiddenIdInput) {
                hiddenIdInput.remove();
            }
        }

        function submitEditForm(event) {
            event.preventDefault();
            const id = document.getElementById('editBarangayId').value;
            const formData = new FormData(document.getElementById('editForm'));
            const dateValue = new Date(document.getElementById('editDate').value);
            const formattedDate = dateValue.getFullYear() + '-' +
                                ('0' + (dateValue.getMonth() + 1)).slice(-2) + '-' +
                                ('0' + dateValue.getDate()).slice(-2);

            const updatedBarangayId = {
                date: formattedDate,
                igp: formData.get('igp'),
                firstName: formData.get('firstName'),
                middleName: formData.get('middleName'),
                lastName: formData.get('lastName'),
                amount: formData.get('amount'),
                remarks: formData.get('remarks'),
                receivedBy: formData.get('receivedBy'),
                status: formData.get('status') // Include the status field
            };

            fetch(`/barangay-ids/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedBarangayId)
            })
            .then(response => {
                if (response.ok) {
                    closeEditModal();
                    fetchBarangayIds(); // Refresh the table
                } else {
                    console.error('Error updating barangay ID:', response.statusText);
                }
            })
            .catch(error => console.error('Error updating barangay ID:', error));
        }

        function deleteBarangayId(id) {
    if (confirm("Are you sure you want to delete this Barangay ID?")) {
        fetch(`/barangay-ids/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                fetchBarangayIds(); // Refresh the table after deletion
            } else {
                alert('Failed to delete Barangay ID');
            }
        })
        .catch(error => {
            console.error('Error deleting Barangay ID:', error);
        });
    }
}


        function transferBarangayId(id) {
            fetch(`/barangay-ids/transfer/${id}`, {
                method: 'PUT',
            })
            .then(response => {
                if (response.ok) {
                    fetchBarangayIds(); // Refresh the table after transfer
                } else {
                    console.error('Error transferring barangay ID:', response.statusText);
                }
            })
            .catch(error => console.error('Error transferring barangay ID:', error));
        }

        // Update Amount Based on Remarks
        function updateAmount() {
            const remarks = document.getElementById('remarks').value;
            const amountField = document.getElementById('amount');

            if (remarks === 'Rush') {
                amountField.value = 50;
            } else if (remarks === 'Regular') {
                amountField.value = 25;
            } else {
                amountField.value = '';
            }
        }

        // Update Amount Based on Remarks in Edit Modal
        function updateEditAmount() {
            const remarks = document.getElementById('editRemarks').value;
            const amountField = document.getElementById('editAmount');

            if (remarks === 'Rush') {
                amountField.value = 50;
            } else if (remarks === 'Regular') {
                amountField.value = 25;
            } else {
                amountField.value = '';
            }
        }

        // Fetch Barangay IDs
        function fetchBarangayIds() {
            fetch('/barangay-ids')
                .then(response => response.json())
                .then(barangayIds => {
                    const tableBody = document.querySelector('#barangayIdTableBody');
                    tableBody.innerHTML = ''; // Clear any existing rows

                    barangayIds.forEach(barangayId => {
                        // Determine the appropriate status icon
                        const statusIcon = barangayId.status === 'Complete'
                            ? '<img src="https://www.dropbox.com/scl/fi/brbnzjxfdeqjerssseaxc/checked.png?rlkey=yinbka4wjvra6n5dxazi4l13a&st=wpwljnp2&dl=1" alt="Complete" class="status-icon">'
                            : '<img src="https://www.dropbox.com/scl/fi/5bv5aqyto4z9york6lzwq/id-card.png?rlkey=crbfg36zcmb1tq9yfdg0t8zm2&st=ocm8u8fd&dl=1" alt="Processing" class="status-icon">';
                        
                        // Create the row for the table
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${barangayId.date}</td>
                            <td>${barangayId.igp}</td>
                            <td>${barangayId.firstName} ${barangayId.middleName} ${barangayId.lastName}</td>
                            <td>${barangayId.amount}</td>
                            <td>${barangayId.remarks}</td>
                            <td>${barangayId.receivedBy}</td>
                            <td>${barangayId.status || 'Processing'}</td>
                            <td>
                                
                                <a href="#"><img src="https://www.dropbox.com/scl/fi/u6i83geituweeaybi8y9w/pen.png?rlkey=5f7vjmsrn42d1t0iaxdu3jbjy&st=0sk8r60h&dl=1" alt="Edit" class="edit-icon" onclick="openEditModal('${barangayId._id}')"></a>
                                <a href="#"><img src="https://www.dropbox.com/scl/fi/ho6y40rqr930v22ja9219/delete.png?rlkey=b1xjg0s1v3rnrgjx1n5v2usgm&st=xgbxk20f&dl=1" alt="Delete" class="delete-icon" onclick="deleteBarangayId('${barangayId._id}')"></a>
                                ${barangayId.status === 'Complete' ? '<a href="#"><img src="https://www.dropbox.com/scl/fi/brbnzjxfdeqjerssseaxc/checked.png?rlkey=yinbka4wjvra6n5dxazi4l13a&st=wpwljnp2&dl=1" alt="Transfer" class="transfer-icon" onclick="transferBarangayId(\'' + barangayId._id + '\')"></a>' : ''}
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error fetching barangay IDs:', error));
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('addForm').addEventListener('submit', submitAddForm);
            document.getElementById('editForm').addEventListener('submit', submitEditForm);
            fetchBarangayIds(); // Fetch and display barangay IDs on page load
        });
    </script>
</body>
</html>
